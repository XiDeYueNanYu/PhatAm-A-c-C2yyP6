<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0"> <!-- Thêm viewport để tối ưu hóa di động -->
    <title>越南语发音练习</title>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            text-align: center; 
            margin: 0; 
            padding-bottom: 300px; /* Mặc định cho màn hình lớn */
            background-color: #f7fbf3; /*f7fbf3  3f4040*/
        }
        #gameContainer {
            display: block;
            min-height: calc(100vh - 150px); /* Đảm bảo nội dung chiếm đủ chiều cao màn hình */
        }
        #infoBox { 
            width: 95%; 
            max-width: 700px;
            min-height: 100px; 
            margin: 0 auto; 
            border: 2px solid #feeec9; /*041b31 1f4263*/
            background: #fede94; /*ecf2e4 fefefc fede94 */
            color: #5b5b5b; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            font-size: clamp(40px, 5vw, 60px);
            font-weight: bold;
        }
        #contactBox { 
            width: 90%; 
            max-width: 700px;
            min-height: 25px; 
            margin: 0px auto; 
            border: 2px solid #feeec9; 
            background: #fede94; 
            color: #6b6b6b; 
            display: flex; 
            align-items: center; 
            justify-content: left; 
            padding-left: 20px;
            font-size: clamp(16px, 2vw, 20px); 
            font-weight: bold;
        }
        #instructionBox { 
            width: 90%; 
            max-width: 700px;
            min-height: 25px; 
            margin: 0px auto; 
            border: 2px solid #feeec9; 
            background: #fede94; 
            color: #6b6b6b; 
            display: flex; 
            align-items: center; 
            justify-content: left; 
            padding-left: 20px;
            font-size: clamp(16px, 2vw, 20px); 
            font-weight: bold;
        }
        #controls { 
            position: fixed; /* Cố định ở cuối màn hình */
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 95%;
            max-width: 800px; /* Giới hạn chiều rộng tối đa */
            background: #f7fbf3;
                        border: 3px solid #f7fbf3;                        
            padding: 10px 0; 
           /* box-shadow: 0 -2px 5px rgba(0, 0, 0, 0.2); */
            z-index: 1000; 
        }
        #controls div {
            margin: 5px 0; 
            display: flex;
            justify-content: center;
            align-items: center;
        }
        button { 
            padding: 8px 8px; 
            margin: 0 5px; 
            cursor: pointer; 
            border: 2px solid #fede94; 
            background: #fede94; /*192332*/
                        box-shadow: 0 5px 5px rgba(0, 0, 0, 0.2);
            color: #5b5b5b; 
            font-size: 28px; 
            border-radius: 5px; 
        }
        #sentenceNumber { 
            width: 50px; 
            padding: 10px; 
            text-align: center; 
            border: 3px solid #fede94; /*041b31 68838B*/
            background: #f8e5ba; 
            color: #000; 
            border-radius: 10px; 
            font-size: 16px; 
            -moz-appearance: textfield; 
        }
        #sentenceNumber::-webkit-inner-spin-button, 
        #sentenceNumber::-webkit-outer-spin-button { 
            -webkit-appearance: none; 
            margin: 0; 
        }
        #sentenceNumber:disabled { 
            background: #eee; 
        }
        .disabled { 
            cursor: not-allowed; 
            pointer-events: none; 
        }
        .active-mode { 
            border: 3px solid #b6d7a8; 
        }
        #indicator { 
            width: 95%;
                        max-width: 700px; 
            min-height: 50px; 
            margin: 10px auto; 
                        padding: 5px;
            border: 3px solid #fed16a; 
            background: #ffffe0; 
            border-radius: 10px; 
            display: flex; 
            flex-direction: column; 
            justify-content: center; 
            align-items: center; 
        }
        #optionsContainer {
            width: 100%;
            max-width: 700px;
            margin: 10px auto;
        }
        .optionBtn {
            width: 95%; 
            max-width: 700px;
            padding: 10px;
            margin: 5px 0;
            border: 2px solid #ffffff;
            background: #ffffff; /*E6EDD9*/
            color: #000000;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
            font-size: 45px;
            text-align: left;
            cursor: pointer;
            border-radius: 5px;
        }
        .optionBtn:hover {
            background: #D2E4C4;
        }
        .correct {
            background: #B7D7AA !important;
        }
        .wrong {
            background: #CE6D5E !important;
        }
        #score { 
            display: none; 
            width: 100%;
            max-width: 700px;
            margin: 10px auto; 
            color: #FF6820; 
            font-size: 30px; 
            text-align: center;
        }
        #wrongSentences { 
            display: none; 
            width: 95%; 
            max-width: 700px; 
            margin: 10px auto; 
            padding: 10px; 
            border: 2px solid #CE6D5E; 
            background: #FFF0F0; 
            color: #CE6D5E; 
            font-size: 30px; 
            text-align: left; 
            border-radius: 5px; 
        }
        #results { 
            display: none; 
            width: 95%;
            max-width: 700px;        
            margin: 10px auto; 
            padding: 10px; 
            border: 2px solid #734A2E; 
            background: #fffbef; 
            color: #000; 
            font-size: 30px; 
            text-align: left; 
            border-radius: 5px; 
            white-space: pre-line;
        }

        /* Media query cho thiết bị di động */
        @media (max-width: 768px) {
            body {
                padding-bottom: 200px; /* Giảm padding-bottom cho điện thoại */
            }
            #controls {
                padding: 5px 0; /* Giảm padding */
            }
            button {
                padding: 6px 6px; /* Giảm kích thước nút */
                font-size: 20px; /* Giảm kích thước chữ */
            }
            #sentenceNumber {
                width: 40px; /* Giảm chiều rộng */
                padding: 8px; /* Giảm padding */
                font-size: 14px; /* Giảm kích thước chữ */
            }
            .optionBtn {
                font-size: 30px; /* Giảm kích thước chữ cho đáp án */
                padding: 8px; /* Giảm padding */
            }
            #infoBox {
                font-size: clamp(30px, 4vw, 40px); /* Giảm kích thước chữ */
            }
            #contactBox, #instructionBox {
                font-size: clamp(14px, 2vw, 16px); /* Giảm kích thước chữ */
            }
            #indicator {
                min-height: 40px; /* Giảm chiều cao tối thiểu */
            }
            #results, #wrongSentences, #score {
                font-size: 24px; /* Giảm kích thước chữ */
                                width: 90%;
            }
        }
    </style>
</head>
<body>
    <div id="gameContainer">
        <div id="infoBox">习得越南语<br>听力-发音</div>
        <div id="contactBox">讲师-阮玉煌 | Weixin：XiDeYueNanYu</div>
        <div id="instructionBox">选择与播放内容相符的选项</div>
        <div id="indicator"></div>
        <div id="optionsContainer"></div>
        <div id="results"></div>
        <div id="score">0/0</div>
        <div id="wrongSentences"></div>
    </div>
    <div id="controls">
        <div>
            <button id="freeModeBtn" class="active-mode">自由模式</button>
            <button id="testModeBtn">作业模式</button>
        </div>
        <div>
            <button id="autoContinueBtn">自动继续</button>
            <button id="showHideBtn">显示-隐藏</button>
        </div>
        <div>
            <button id="prevBtn">◀</button>
            <input type="text" id="sentenceNumber" inputmode="numeric" pattern="[0-9]*">
            <button id="nextBtn">▶</button>
            <button id="replayBtn">再听一遍</button>
        </div>
    </div>
    <audio id="mainAudio" src="audio.mp3"></audio>
    <audio id="correctAudio" src="Dung.mp3"></audio>
    <audio id="wrongAudio" src="Sai.mp3"></audio>

    <script>
        const audio = document.getElementById('mainAudio');
        const correctAudio = document.getElementById('correctAudio');
        const wrongAudio = document.getElementById('wrongAudio');
        const indicator = document.getElementById('indicator');
        const sentenceNumber = document.getElementById('sentenceNumber');
        const prevBtn = document.getElementById('prevBtn');
        const nextBtn = document.getElementById('nextBtn');
        const replayBtn = document.getElementById('replayBtn');
        const freeModeBtn = document.getElementById('freeModeBtn');
        const testModeBtn = document.getElementById('testModeBtn');
        const autoContinueBtn = document.getElementById('autoContinueBtn');
        const showHideBtn = document.getElementById('showHideBtn');
        const scoreDisplay = document.getElementById('score');
        const wrongSentencesDisplay = document.getElementById('wrongSentences');
        const optionsContainer = document.getElementById('optionsContainer');
        const resultsDisplay = document.getElementById('results');

        const buttons = [prevBtn, nextBtn, replayBtn, freeModeBtn, testModeBtn, autoContinueBtn, showHideBtn];

const sentences = [
    {
        "audioFile": "audio.mp3",
        "start": 2.054966,
        "end": 2.902494,
        "correctAnswer": "bưng",
        "translation": "选择你所听到的声音对应的写法",
        "options": [
            "bưng",
            "bứng",
            "pưng"
        ]
    },
    {
        "audioFile": "audio.mp3",
        "start": 3.44,
        "end": 4.04,
        "correctAnswer": "mộng",
        "translation": "选择你所听到的声音对应的写法",
        "options": [
            "mộng",
            "bộng",
            "mộn"
        ]
    },
    {
        "audioFile": "audio.mp3",
        "start": 4.85,
        "end": 5.53,
        "correctAnswer": "bang",
        "translation": "选择你所听到的声音对应的写法",
        "options": [
            "mang",
            "bang",
            "man"
        ]
    },
    {
        "audioFile": "audio.mp3",
        "start": 6.35,
        "end": 6.94,
        "correctAnswer": "mong",
        "translation": "选择你所听到的声音对应的写法",
        "options": [
            "mong",
            "bong",
            "mòng"
        ]
    },
    {
        "audioFile": "audio.mp3",
        "start": 7.82,
        "end": 8.43,
        "correctAnswer": "mừng",
        "translation": "选择你所听到的声音对应的写法",
        "options": [
            "mừng",
            "bừng",
            "bừn"
        ]
    },
    {
        "audioFile": "audio.mp3",
        "start": 9.28,
        "end": 9.99,
        "correctAnswer": "mang",
        "translation": "选择你所听到的声音对应的写法",
        "options": [
            "mang",
            "nang",
            "nan"
        ]
    },
    {
        "audioFile": "audio.mp3",
        "start": 10.72,
        "end": 11.36,
        "correctAnswer": "bông",
        "translation": "选择你所听到的声音对应的写法",
        "options": [
            "bông",
            "bôn",
            "mông"
        ]
    },
    {
        "audioFile": "audio.mp3",
        "start": 12.12,
        "end": 12.73,
        "correctAnswer": "bọng",
        "translation": "选择你所听到的声音对应的写法",
        "options": [
            "bọng",
            "mọng",
            "bọn"
        ]
    },
    {
        "audioFile": "audio.mp3",
        "start": 13.56,
        "end": 14.21,
        "correctAnswer": "nạng",
        "translation": "选择你所听到的声音对应的写法",
        "options": [
            "nạng",
            "lạng",
            "lạn"
        ]
    },
    {
        "audioFile": "audio.mp3",
        "start": 14.95,
        "end": 15.56,
        "correctAnswer": "lộng",
        "translation": "选择你所听到的声音对应的写法",
        "options": [
            "lộng",
            "nộng",
            "lộn"
        ]
    },
    {
        "audioFile": "audio.mp3",
        "start": 16.25,
        "end": 16.9,
        "correctAnswer": "nóng",
        "translation": "选择你所听到的声音对应的写法",
        "options": [
            "nóng",
            "lóng",
            "nón"
        ]
    },
    {
        "audioFile": "audio.mp3",
        "start": 17.7,
        "end": 18.34,
        "correctAnswer": "nựng",
        "translation": "选择你所听到的声音对应的写法",
        "options": [
            "nựng",
            "lựng",
            "nụng"
        ]
    },
    {
        "audioFile": "audio.mp3",
        "start": 19.05,
        "end": 19.79,
        "correctAnswer": "làng",
        "translation": "选择你所听到的声音对应的写法",
        "options": [
            "làng",
            "nàng",
            "làn"
        ]
    },
    {
        "audioFile": "audio.mp3",
        "start": 20.55,
        "end": 21.18,
        "correctAnswer": "nông",
        "translation": "选择你所听到的声音对应的写法",
        "options": [
            "nông",
            "lông",
            "nong"
        ]
    },
    {
        "audioFile": "audio.mp3",
        "start": 21.85,
        "end": 22.51,
        "correctAnswer": "lưng",
        "translation": "选择你所听到的声音对应的写法",
        "options": [
            "lưng",
            "nưng",
            "nung"
        ]
    },
    {
        "audioFile": "audio.mp3",
        "start": 23.31,
        "end": 23.82,
        "correctAnswer": "thững",
        "translation": "选择你所听到的声音对应的写法",
        "options": [
            "thứng",
            "thững",
            "thừng"
        ]
    },
    {
        "audioFile": "audio.mp3",
        "start": 24.62,
        "end": 25.22,
        "correctAnswer": "tung",
        "translation": "选择你所听到的声音对应的写法",
        "options": [
            "tung",
            "thung",
            "tun"
        ]
    },
    {
        "audioFile": "audio.mp3",
        "start": 25.97,
        "end": 26.54,
        "correctAnswer": "thông",
        "translation": "选择你所听到的声音对应的写法",
        "options": [
            "thông",
            "tông",
            "tôn"
        ]
    },
    {
        "audioFile": "audio.mp3",
        "start": 27.25,
        "end": 27.82,
        "correctAnswer": "tưng",
        "translation": "选择你所听到的声音对应的写法",
        "options": [
            "tưng",
            "thưng",
            "thun"
        ]
    },
    {
        "audioFile": "audio.mp3",
        "start": 28.56,
        "end": 29.22,
        "correctAnswer": "thùng",
        "translation": "选择你所听到的声音对应的写法",
        "options": [
            "thùng",
            "thùn",
            "thừng"
        ]
    },
    {
        "audioFile": "audio.mp3",
        "start": 29.88,
        "end": 30.51,
        "correctAnswer": "tổng",
        "translation": "选择你所听到的声音对应的写法",
        "options": [
            "tổng",
            "tống",
            "tỗng"
        ]
    },
    {
        "audioFile": "audio.mp3",
        "start": 31.26,
        "end": 31.93,
        "correctAnswer": "xẻng",
        "translation": "选择你所听到的声音对应的写法",
        "options": [
            "xẻng",
            "xẻn",
            "xểng"
        ]
    },
    {
        "audioFile": "audio.mp3",
        "start": 32.63,
        "end": 33.19,
        "correctAnswer": "sững",
        "translation": "选择你所听到的声音对应的写法",
        "options": [
            "sững",
            "sữ",
            "sũng"
        ]
    },
    {
        "audioFile": "audio.mp3",
        "start": 33.87,
        "end": 34.5,
        "correctAnswer": "xạng",
        "translation": "选择你所听到的声音对应的写法",
        "options": [
            "xạng",
            "xạn",
            "xan"
        ]
    },
    {
        "audioFile": "audio.mp3",
        "start": 35.19,
        "end": 35.88,
        "correctAnswer": "sung",
        "translation": "选择你所听到的声音对应的写法",
        "options": [
            "sung",
            "sùng",
            "súng"
        ]
    },
    {
        "audioFile": "audio.mp3",
        "start": 36.46,
        "end": 37.09,
        "correctAnswer": "xông",
        "translation": "选择你所听到的声音对应的写法",
        "options": [
            "xông",
            "xong",
            "xơng"
        ]
    },
    {
        "audioFile": "audio.mp3",
        "start": 37.77,
        "end": 38.46,
        "correctAnswer": "song",
        "translation": "选择你所听到的声音对应的写法",
        "options": [
            "song",
            "sóng",
            "sòng"
        ]
    },
    {
        "audioFile": "audio.mp3",
        "start": 39.07,
        "end": 39.72,
        "correctAnswer": "xong",
        "translation": "选择你所听到的声音对应的写法",
        "options": [
            "xong",
            "xơng",
            "xông"
        ]
    },
    {
        "audioFile": "audio.mp3",
        "start": 40.48,
        "end": 41.1,
        "correctAnswer": "sông",
        "translation": "选择你所听到的声音对应的写法",
        "options": [
            "sông",
            "sôn",
            "song"
        ]
    },
    {
        "audioFile": "audio.mp3",
        "start": 41.83,
        "end": 42.49,
        "correctAnswer": "xung",
        "translation": "选择你所听到的声音对应的写法",
        "options": [
            "xung",
            "xưng",
            "xun"
        ]
    },
    {
        "audioFile": "audio.mp3",
        "start": 43.14,
        "end": 43.86,
        "correctAnswer": "sáng",
        "translation": "选择你所听到的声音对应的写法",
        "options": [
            "sáng",
            "sán",
            "sang"
        ]
    },
    {
        "audioFile": "audio.mp3",
        "start": 44.53,
        "end": 45.11,
        "correctAnswer": "xưng",
        "translation": "选择你所听到的声音对应的写法",
        "options": [
            "xưng",
            "xun",
            "xưn"
        ]
    },
    {
        "audioFile": "audio.mp3",
        "start": 45.83,
        "end": 46.41,
        "correctAnswer": "dựng",
        "translation": "选择你所听到的声音对应的写法",
        "options": [
            "dựng",
            "dững",
            "dừng"
        ]
    },
    {
        "audioFile": "audio.mp3",
        "start": 47.15,
        "end": 47.86,
        "correctAnswer": "giang",
        "translation": "选择你所听到的声音对应的写法",
        "options": [
            "giang",
            "giáng",
            "dạng"
        ]
    },
    {
        "audioFile": "audio.mp3",
        "start": 48.47,
        "end": 49.05,
        "correctAnswer": "rung",
        "translation": "选择你所听到的声音对应的写法",
        "options": [
            "rung",
            "rùng",
            "rũng"
        ]
    },
    {
        "audioFile": "audio.mp3",
        "start": 49.72,
        "end": 50.38,
        "correctAnswer": "giông",
        "translation": "选择你所听到的声音对应的写法",
        "options": [
            "giông",
            "giống",
            "giỗng"
        ]
    },
    {
        "audioFile": "audio.mp3",
        "start": 51.04,
        "end": 51.73,
        "correctAnswer": "dòng",
        "translation": "选择你所听到的声音对应的写法",
        "options": [
            "dòng",
            "dồng",
            "dòn"
        ]
    },
    {
        "audioFile": "audio.mp3",
        "start": 52.4,
        "end": 53.08,
        "correctAnswer": "reng",
        "translation": "选择你所听到的声音对应的写法",
        "options": [
            "reng",
            "réng",
            "ren"
        ]
    },
    {
        "audioFile": "audio.mp3",
        "start": 53.68,
        "end": 54.34,
        "correctAnswer": "rưng",
        "translation": "选择你所听到的声音对应的写法",
        "options": [
            "rưng",
            "rưn",
            "rung"
        ]
    },
    {
        "audioFile": "audio.mp3",
        "start": 54.93,
        "end": 55.65,
        "correctAnswer": "rang",
        "translation": "选择你所听到的声音对应的写法",
        "options": [
            "rang",
            "ráng",
            "ran"
        ]
    },
    {
        "audioFile": "audio.mp3",
        "start": 56.17,
        "end": 56.83,
        "correctAnswer": "dạng",
        "translation": "选择你所听到的声音对应的写法",
        "options": [
            "dạng",
            "dáng",
            "dán"
        ]
    },
    {
        "audioFile": "audio.mp3",
        "start": 57.41,
        "end": 58.06,
        "correctAnswer": "rùng",
        "translation": "选择你所听到的声音对应的写法",
        "options": [
            "rùng",
            "rung",
            "rồng"
        ]
    },
    {
        "audioFile": "audio.mp3",
        "start": 59.07,
        "end": 59.7,
        "correctAnswer": "giông",
        "translation": "选择你所听到的声音对应的写法",
        "options": [
            "giông",
            "giống",
            "rộng"
        ]
    },
    {
        "audioFile": "audio.mp3",
        "start": 61.03,
        "end": 61.63,
        "correctAnswer": "rộng",
        "translation": "选择你所听到的声音对应的写法",
        "options": [
            "rộng",
            "rộn",
            "giông"
        ]
    },
    {
        "audioFile": "audio.mp3",
        "start": 62.32,
        "end": 62.91,
        "correctAnswer": "giọng",
        "translation": "选择你所听到的声音对应的写法",
        "options": [
            "giọng",
            "gióng",
            "ròng"
        ]
    },
    {
        "audioFile": "audio.mp3",
        "start": 63.58,
        "end": 64.32,
        "correctAnswer": "keng",
        "translation": "选择你所听到的声音对应的写法",
        "options": [
            "keng",
            "ceng",
            "kheng"
        ]
    },
    {
        "audioFile": "audio.mp3",
        "start": 64.93,
        "end": 65.47,
        "correctAnswer": "cưng",
        "translation": "选择你所听到的声音对应的写法",
        "options": [
            "kưng",
            "cưng",
            "kứng"
        ]
    },
    {
        "audioFile": "audio.mp3",
        "start": 66.15,
        "end": 66.81,
        "correctAnswer": "càng",
        "translation": "选择你所听到的声音对应的写法",
        "options": [
            "càng",
            "càn",
            "kàng"
        ]
    },
    {
        "audioFile": "audio.mp3",
        "start": 67.43,
        "end": 68.07,
        "correctAnswer": "cung",
        "translation": "选择你所听到的声音对应的写法",
        "options": [
            "công",
            "cung",
            "cơng"
        ]
    },
    {
        "audioFile": "audio.mp3",
        "start": 68.67,
        "end": 69.36,
        "correctAnswer": "công",
        "translation": "选择你所听到的声音对应的写法",
        "options": [
            "công",
            "kông",
            "không"
        ]
    },
    {
        "audioFile": "audio.mp3",
        "start": 69.91,
        "end": 70.52,
        "correctAnswer": "cõng",
        "translation": "选择你所听到的声音对应的写法",
        "options": [
            "khõng",
            "cong",
            "cõng"
        ]
    },
    {
        "audioFile": "audio.mp3",
        "start": 71.12,
        "end": 71.81,
        "correctAnswer": "kháng",
        "translation": "选择你所听到的声音对应的写法",
        "options": [
            "kháng",
            "káng",
            "cáng"
        ]
    },
    {
        "audioFile": "audio.mp3",
        "start": 72.29,
        "end": 72.87,
        "correctAnswer": "hưng",
        "translation": "选择你所听到的声音对应的写法",
        "options": [
            "hưng",
            "hung",
            "hùng"
        ]
    },
    {
        "audioFile": "audio.mp3",
        "start": 73.44,
        "end": 74.18,
        "correctAnswer": "hàng",
        "translation": "选择你所听到的声音对应的写法",
        "options": [
            "hang",
            "hàng",
            "hàn"
        ]
    },
    {
        "audioFile": "audio.mp3",
        "start": 74.66,
        "end": 75.25,
        "correctAnswer": "khung",
        "translation": "选择你所听到的声音对应的写法",
        "options": [
            "không",
            "khôn",
            "khung"
        ]
    },
    {
        "audioFile": "audio.mp3",
        "start": 75.85,
        "end": 76.51,
        "correctAnswer": "hùng",
        "translation": "选择你所听到的声音对应的写法",
        "options": [
            "hùng",
            "hồng",
            "hòng"
        ]
    },
    {
        "audioFile": "audio.mp3",
        "start": 77.07,
        "end": 77.66,
        "correctAnswer": "không",
        "translation": "选择你所听到的声音对应的写法",
        "options": [
            "khôn",
            "khong",
            "không"
        ]
    },
    {
        "audioFile": "audio.mp3",
        "start": 78.29,
        "end": 78.91,
        "correctAnswer": "hồng",
        "translation": "选择你所听到的声音对应的写法",
        "options": [
            "hòn",
            "hòng",
            "hồng"
        ]
    },
    {
        "audioFile": "audio.mp3",
        "start": 79.43,
        "end": 80.02,
        "correctAnswer": "họng",
        "translation": "选择你所听到的声音对应的写法",
        "options": [
            "họng",
            "hộng",
            "hộn"
        ]
    }
];

        let currentIndex = 0;
        let isFreeMode = true;
        let correctCount = 0;
        let isPlaying = false;
        let correctSentences = new Set();
        let wrongSentences = new Set();
        let autoContinue = false;
        let showAnswer = false;
        let userAnswers = [];

        // Fisher-Yates shuffle algorithm
        function shuffleArray(array) {
            const shuffled = [...array];
            for (let i = shuffled.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
            }
            return shuffled;
        }

        function init() {
            updateSentenceDisplay();
        }

        function updateSentenceDisplay() {
            sentenceNumber.value = currentIndex + 1;
            indicator.style.background = '#ffffe0';
            if (isFreeMode && showAnswer) {
                indicator.innerHTML = `
                    <div style="font-size: 18px; font-weight: bold; color: #2f2f2f;">${sentences[currentIndex].translation}</div>
                `;
            } else {
                indicator.innerHTML = '';
            }
            updateOptions();
            if (!isFreeMode) updateScore();
        }

        function updateOptions() {
            optionsContainer.innerHTML = '';
            const shuffledOptions = shuffleArray(sentences[currentIndex].options);
            shuffledOptions.forEach((option, index) => {
                const btn = document.createElement('button');
                btn.className = 'optionBtn';
                btn.textContent = option;
                btn.onclick = () => checkAnswer(option);
                optionsContainer.appendChild(btn);
            });
        }

        function playCurrentSentence() {
            if (isPlaying) audio.pause();
            buttons.forEach(btn => btn.classList.add('disabled'));
            sentenceNumber.disabled = true;
            isPlaying = true;
            audio.src = sentences[currentIndex].audioFile;
            audio.currentTime = sentences[currentIndex].start;
            audio.play().catch(error => {
                console.error('Audio playback failed:', error);
                alert('Vui lòng nhấn nút “再听一遍” để phát âm thanh.');
                buttons.forEach(btn => btn.classList.remove('disabled'));
                sentenceNumber.disabled = false;
                isPlaying = false;
            });

            audio.ontimeupdate = () => {
                if (audio.currentTime >= sentences[currentIndex].end) {
                    audio.pause();
                    audio.ontimeupdate = null;
                    buttons.forEach(btn => btn.classList.remove('disabled'));
                    sentenceNumber.disabled = false;
                    isPlaying = false;
                }
            };
        }

        function moveSentence(direction) {
            currentIndex = (currentIndex + direction + sentences.length) % sentences.length;
            updateSentenceDisplay();
            playCurrentSentence();
        }

        function checkAnswer(selectedAnswer) {
            const correctAnswer = sentences[currentIndex].correctAnswer;
            const optionButtons = optionsContainer.getElementsByClassName('optionBtn');
            
            // Clear previous styles
            for (let btn of optionButtons) {
                btn.classList.remove('correct', 'wrong');
                btn.disabled = !isFreeMode; // Only disable buttons in Test Mode
            }

            // Find and style the selected button
            for (let btn of optionButtons) {
                if (btn.textContent === selectedAnswer) {
                    if (selectedAnswer === correctAnswer) {
                        indicator.style.background = '#B7D7AA';
                                                indicator.innerHTML = `
                    <div style="font-size: 18px; font-weight: bold; color: #000000;">${sentences[currentIndex].translation}</div>
                `;
                        btn.classList.add('correct');
                        correctAudio.play().catch(error => {
                            console.error('Correct audio playback failed:', error);
                        });
                    } else {
                        indicator.style.background = '#CE6D5E';
                                                indicator.innerHTML = `
                    <div style="font-size: 18px; font-weight: bold; color: #000000;">${sentences[currentIndex].translation}</div>
                `;
                        btn.classList.add('wrong');
                        wrongAudio.play().catch(error => {
                            console.error('Wrong audio playback failed:', error);
                        });
                    }
                }
            }

            if (!isFreeMode) {
                userAnswers[currentIndex] = selectedAnswer;
                if (selectedAnswer === correctAnswer && !correctSentences.has(currentIndex)) {
                    correctCount++;
                    correctSentences.add(currentIndex);
                    wrongSentences.delete(currentIndex);
                } else if (selectedAnswer !== correctAnswer && !correctSentences.has(currentIndex)) {
                    wrongSentences.add(currentIndex);
                }
                updateScore();

                // Auto-move to next sentence in Test Mode
                const audioToWait = (selectedAnswer === correctAnswer) ? correctAudio : wrongAudio;
                audioToWait.onended = () => {
                    if (userAnswers.length === sentences.length) {
                        showResults();
                    } else {
                        setTimeout(() => {
                            moveSentence(1);
                        }, 200);
                    }
                };
            } else if (isFreeMode && autoContinue && selectedAnswer === correctAnswer) {
                // Auto-move in Free Mode only if answer is correct and autoContinue is enabled
                correctAudio.onended = () => {
                    setTimeout(() => {
                        moveSentence(1);
                    }, 200);
                };
            } else {
                correctAudio.onended = null;
                wrongAudio.onended = null;
            }
        }

        function updateScore() {
            scoreDisplay.textContent = `${correctCount}/${sentences.length}`;
            scoreDisplay.style.display = 'block'; // Hiển thị score trong Test Mode
        }

        function showResults() {
            let resultText = `练习完成！\n正确答案数量：${correctCount}/${sentences.length}\n正确率：${((correctCount / sentences.length) * 100).toFixed(2)}%\n错误题目：`;
            wrongSentences.forEach(index => {
                resultText += `\n第${index + 1}题：\n你的选择：${userAnswers[index] || '未选择'}\n正确答案：${sentences[index].correctAnswer}\n`;
            });
            if (wrongSentences.size === 0) {
                resultText += '\n全部正确！';
            }
            resultsDisplay.textContent = resultText;
            resultsDisplay.style.display = 'block';
        }

        prevBtn.onclick = () => {
            moveSentence(-1);
        };

        nextBtn.onclick = () => {
            moveSentence(1);
        };

        replayBtn.onclick = () => {
            playCurrentSentence();
        };

        freeModeBtn.onclick = () => {
            isFreeMode = true;
            freeModeBtn.classList.add('active-mode');
            testModeBtn.classList.remove('active-mode');
            autoContinueBtn.disabled = false;
            autoContinueBtn.classList.remove('disabled');
            showHideBtn.disabled = false;
            showHideBtn.classList.remove('disabled');
            scoreDisplay.style.display = 'none';
            wrongSentencesDisplay.style.display = 'none';
            resultsDisplay.style.display = 'none';
            updateSentenceDisplay();
        };

        testModeBtn.onclick = () => {
            isFreeMode = false;
            testModeBtn.classList.add('active-mode');
            freeModeBtn.classList.remove('active-mode');
            autoContinueBtn.disabled = true;
            autoContinueBtn.classList.add('disabled');
            showHideBtn.disabled = true;
            showHideBtn.classList.add('disabled');
            showHideBtn.classList.remove('active-mode');
            showAnswer = false;
            scoreDisplay.style.display = 'block';
            currentIndex = 0;
            correctCount = 0;
            correctSentences.clear();
            wrongSentences.clear();
            userAnswers = [];
            for (let i = 0; i < sentences.length; i++) {
                wrongSentences.add(i);
            }
            updateSentenceDisplay();
        };

        autoContinueBtn.onclick = () => {
            if (isFreeMode) {
                autoContinue = !autoContinue;
                autoContinueBtn.classList.toggle('active-mode');
                if (!autoContinue) {
                    correctAudio.onended = null;
                }
            }
        };

        showHideBtn.onclick = () => {
            if (isFreeMode) {
                showAnswer = !showAnswer;
                showHideBtn.classList.toggle('active-mode');
                updateSentenceDisplay();
            }
        };

        sentenceNumber.onchange = () => {
            if (!isPlaying) {
                const num = parseInt(sentenceNumber.value) - 1;
                if (!isNaN(num) && num >= 0 && num < sentences.length) {
                    currentIndex = num;
                    updateSentenceDisplay();
                    playCurrentSentence();
                } else {
                    alert(`输入范围： 1 到 ${sentences.length}`);
                    updateSentenceDisplay();
                }
            }
        };

        sentenceNumber.onkeydown = (e) => {
            if (!isPlaying) {
                if (e.key === 'ArrowLeft') {
                    moveSentence(-1);
                }
                if (e.key === 'ArrowRight') {
                    moveSentence(1);
                }
            }
        };

        init();
    </script>
</body>
</html>